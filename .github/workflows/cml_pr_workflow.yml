name: Model Training & Reporting (CML)
on:
  pull_request:
    # This workflow runs only when a PR is created or updated
    # targeting the 'main' branch (i.e., dev -> main)
    branches: [main]

jobs:
  run_cml:
    runs-on: [ubuntu-latest] # Use a standard GitHub-hosted runner
    
    permissions:
      pull-requests: write
    # Optional: Use a larger runner for demanding ML tasks (if needed)
    # runs-on: [self-hosted, large] 

    container:
      # Use a CML-optimized image with common ML dependencies pre-installed
      image: docker://ghcr.io/iterative/cml:0-dvc2-base1

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for CML features that compare branches

      - name: Setup Python Dependencies
        run: |
          # Install necessary Python dependencies
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run Training Script (Generates Model Artifact)
        # train.py creates artifacts/model.pkl and artifacts/X_test.csv/y_test.csv
        run: python train.py
        
      - name: Run Evaluation Script (Generates Metrics and Plot)
        # eval.py loads the model, evaluates, and creates artifacts/confusion_matrix.png
        run: python eval.py

      - name: Post CML Report to PR
        env:
          # CML uses the GITHUB_TOKEN to comment on the PR
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
        run: |
          # The cml-send-comment command reads the markdown file generated by eval.py
          # cml-send-comment cml_report.md
          cml comment create cml_report.md
          
          # Optional: You can also include the full raw metrics JSON/text file
          # cml-send-comment artifacts/metrics.json --append
